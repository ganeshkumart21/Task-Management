<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

</head>

<body>
    <div class="navbar-1" id="navbar">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <nav class="navbar navbar-expand-lg">
                        <a class="navbar-brand" href="#"> <img src="/assets/images/task-logo-1.jpg" width="20%"
                                alt="logo"> </a>
                        <button class="navbar-toggler shadow-none" type="button" data-bs-toggle="collapse"
                            data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                            aria-expanded="false" aria-label="Toggle navigation">
                            <i class="fas fa-bars"></i>
                        </button>
                        <div class="collapse navbar-collapse" id="navbarSupportedContent">
                            <ul class="navbar-nav">
                                <li class="nav-item">
                                    <a class="nav-link" aria-current="page" href="#">Home</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" aria-current="page" href="#">Features</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" aria-current="page" href="#">Browse</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#features">AboutUs</a>
                                </li>
                            </ul>
                            <div class="d-md-flex btn-wrap">
                                <a type="button" class="btn">Signup</a>
                            </div>
                            <div class="d-md-flex btn-wrap-1">
                                <a type="button" class="btn">Login</a>
                            </div>
                        </div>
                    </nav>
                </div>
            </div>
        </div>
    </div>



    <div class="container">
        <div class="row">
            <div class="col-lg-12 col-md-6 d-flex row justify-content-center align-items-center">
                <div class="form-wrap d-flex justify-content-between" action="/logout">
                    <h1 class="text-center">Welcome
                        <span id="welcomeMsg"></span>
                    </h1>
                    <div>
                        <button type="button" class="logout-btn" data-bs-toggle="modal" data-bs-target="#taskModal">
                            <i class="fa fa-plus"></i> Add Task</button>
                        <button type="button" id="logout-btn" class="logout-btn">logout</button>
                    </div>

                </div>
            </div>

            <!-- Add Task Modal -->
            <div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">

                        <!-- Modal Header -->
                        <div class="modal-header">
                            <h5 class="modal-title" id="taskModalLabel">Add New Task</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>

                        <!-- Modal Body -->
                        <div class="modal-body">
                            <form id="taskForm">
                                <div class="mb-3">
                                    <label for="title" class="form-label">Title</label>
                                    <input type="text" class="form-control" id="title" required>
                                </div>
                                <div class="mb-3">
                                    <label for="description" class="form-label">Description</label>
                                    <textarea class="form-control" id="description" required></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="status" class="form-label">Status</label>
                                    <select class="form-select" id="status" required>
                                        <option value="Pending">Pending</option>
                                        <option value="Completed">Completed</option>
                                    </select>
                                </div>
                                <div class="mb-3 d-flex justify-content-center">
                                    <button type="submit" class="btn btn-primary">Add Task</button>
                                </div>
                            </form>
                        </div>

                    </div>
                </div>
            </div>


            <div class="data-table col-lg-12 col-md-6">
                <table class="table  table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th colspan="4" class="text-center">Task List</th>
                        </tr>
                    </thead>
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Description</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="userTable">
                    </tbody>
                </table>
            </div>

        </div>
    </div>

    <div class="footer">
        <div class="container">
            <div class="row justify-content-between">
                <div class="col-lg-3 col-md-3 col-6">
                    <div class="footer_wrap">
                        <img src="/assets/images/task-logo.png" alt="f-logo" width="60%">
                        <p>
                            Lorem ipsum dolor sit amet consectetur. Eleifend diam ipsum tortor dignissim natoque erat
                            aenean habitasse.
                        </p>
                        <h3>Follow Us:</h3>
                        <ul>
                            <li><a href="#"><i class="fa-brands fa-linkedin-in"></i></a></li>
                            <li><a href="#"><i class="fa-brands fa-facebook-f"></i></a></li>
                            <li><a href="#"><i class="fa-brands fa-instagram"></i></a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-8 col-md-12">
                    <div class="row justify-content-end">
                        <div class="col-lg-4 col-md-6">
                            <div class="quick_links">
                                <h4>Company</h4>
                                <ul>
                                    <li><a href="#Lorem ipsum.html">Home</a></li>
                                    <li><a href="#support.html"> Features</a></li>
                                    <li><a href="#pricing.html">About us</a></li>
                                    <li><a href="#contact-us.html">FAQs</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6">
                            <div class="quick_links">
                                <h4>Community</h4>
                                <ul>
                                    <li><a href="#Loremipsum.html">Blog</a></li>
                                    <li><a href="#support.html">Webinar</a></li>
                                    <li><a href="#Loremipsum.html">Help</a></li>
                                    <li><a href="#contact-us.html">Terms & Conditions</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6">
                            <div class="add_links">
                                <h4>Contact</h4>
                                <ul>
                                    <li><a href="#"><i class="fa-regular fa-envelope"></i> example@gmail.com</a></li>
                                    <li><a href="#"><i class="fa-solid fa-phone"></i> 043-45632855</a></li>
                                </ul>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="b-footer p-3">
        <div class="container-fluid">
            <p class="d-flex justify-content-center mb-0">
                All rights reserved by Practical Theory, Inc.
                <script>document.write(new Date().getFullYear())</script>
            </p>
        </div>
    </div>

    <script>
        // Load user data when the page loads

        document.addEventListener('DOMContentLoaded', () => {
            loadUser();
        });
        const loadUser = async () => {
            try {
                const res = await fetch('/api/user', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!res.ok) throw new Error("User not logged in");

                const data = await res.json();
                document.getElementById('welcomeMsg').innerText = `${data.username}`;
            } catch (err) {
                console.error(err.message);
            }

        }

        // Fetch the tasks of the logged-in user when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            getTasks();
        });

        // Fetch tasks and update the table
        const getTasks = async () => {
            try {
                const response = await fetch('/users', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include' // Send session cookie
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch tasks');
                }

                const tasks = await response.json();
                const tableBody = document.getElementById("userTable");
                tableBody.innerHTML = ""; // Clear any existing rows

                tasks.forEach((task) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                    <td>${task.title}</td>
                    <td>${task.description}</td>
                    <td>${task.status}</td>
                `;
                    tableBody.appendChild(row);
                });
            } catch (error) {  
                console.error('Error fetching tasks:', error);
            }
        };

        // Add task functionality
        document.getElementById("taskForm").addEventListener('submit', async (event) => {
            event.preventDefault();

            const title = document.getElementById("title").value.trim();
            const description = document.getElementById("description").value.trim();
            const status = document.getElementById("status").value;

            const taskData = {
                title,
                description,
                status
            };

            try {
                const response = await fetch('/add-task', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(taskData),
                });

                const result = await response.json();

                if (response.ok) {
                    alert(result.message || "Task added successfully");
                    document.getElementById("taskForm").reset();
                    const taskModal = bootstrap.Modal.getInstance(document.getElementById('taskModal'));
                    taskModal.hide();
                    getTasks(); // Refresh task list
                } else {
                    alert(result.message || "Failed to add task");
                }
            } catch (error) {
                console.error("Error adding task:", error);
                alert("Something went wrong");
            }
        });



        //Logout user
        const form = document.getElementById("logout-btn")

        form.addEventListener("click", async () => {
            try {
                const response = await fetch('/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                const result = await response.json();

                if (response.ok) {
                    alert(result.message);
                    window.location.href = "/login.html";  // Redirect to login page
                } else {
                    alert(result.message || "Logout failed. Please try again.");
                }
            } catch (error) {
                console.error('Error:', error);
                alert("Logout failed. Please try again.");
            }
        });

    </script>
</body>

</html>